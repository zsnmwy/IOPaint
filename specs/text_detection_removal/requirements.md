# 需求文档 - 文字识别与移除功能

## 介绍

为 IOPaint 项目添加基于 EasyOCR 的文字识别和选择性移除功能，允许用户自动检测图片中的文字区域，通过可交互的矩形框选择要移除的文字，最后使用现有的 inpainting 功能完成文字移除。

## 需求

### 需求 1 - 文字区域检测

**用户故事：** 作为用户，我希望能够自动检测图片中的所有文字区域，以便快速定位需要移除的文字。

#### 验收标准

1. When 用户点击"检测文字"按钮时，系统应当调用后端 OCR API 识别图片中的所有文字区域。
2. When OCR 处理完成时，系统应当在前端显示所有检测到的文字区域的矩形框。
3. When 检测过程中时，系统应当显示加载状态指示器。
4. When 检测失败时，系统应当显示友好的错误提示信息。
5. When 图片中没有检测到文字时，系统应当提示用户"未检测到文字区域"。

### 需求 2 - 文字区域交互编辑

**用户故事：** 作为用户，我希望能够调整检测到的文字区域边界，以便精确选择要移除的文字范围。

#### 验收标准

1. When 文字区域显示后，用户应当能够通过拖动矩形框的四条边来调整区域大小。
2. When 用户拖动矩形框的四个角时，系统应当同时调整宽度和高度。
3. When 用户拖动矩形框的中心区域时，系统应当移动整个矩形框的位置。
4. When 用户调整矩形框时，系统应当实时显示调整后的边界。
5. When 矩形框超出图片边界时，系统应当限制其在图片范围内。
6. When 矩形框小于最小尺寸（如 10x10 像素）时，系统应当阻止继续缩小。

### 需求 3 - 文字区域管理

**用户故事：** 作为用户，我希望能够添加、删除文字区域，以便灵活控制要移除的文字。

#### 验收标准

1. When 用户点击矩形框上的删除按钮时，系统应当移除该文字区域。
2. When 用户点击"添加区域"按钮时，系统应当在图片中心创建一个新的可编辑矩形框。
3. When 用户点击"清除所有"按钮时，系统应当移除所有文字区域并请求确认。
4. When 文字区域被删除时，系统应当从状态中移除该区域的数据。
5. When 没有任何文字区域时，"移除文字"按钮应当被禁用。

### 需求 4 - Mask 生成与文字移除

**用户故事：** 作为用户，我希望能够将选中的文字区域转换为 mask 并执行 inpainting，以便移除图片中的文字。

#### 验收标准

1. When 用户点击"移除文字"按钮时，系统应当将所有文字区域转换为白色 mask。
2. When mask 生成完成时，系统应当调用现有的 inpainting API 进行文字移除。
3. When inpainting 处理中时，系统应当显示处理进度。
4. When 文字移除完成时，系统应当显示处理后的图片。
5. When 文字移除失败时，系统应当显示错误信息并保留原图。
6. When 文字移除成功后，系统应当清空所有文字区域状态。

### 需求 5 - 视觉反馈与用户体验

**用户故事：** 作为用户，我希望获得清晰的视觉反馈，以便了解当前的操作状态。

#### 验收标准

1. When 矩形框被选中时，系统应当高亮显示该矩形框（如加粗边框或改变颜色）。
2. When 鼠标悬停在矩形框的可拖动区域时，系统应当改变鼠标光标样式。
3. When 矩形框显示时，系统应当在矩形框旁边显示识别到的文字内容（可选）。
4. When 矩形框显示时，系统应当使用半透明的背景色填充矩形框内部。
5. When 用户正在拖动矩形框时，系统应当提供流畅的视觉反馈。

### 需求 6 - 快捷键支持

**用户故事：** 作为用户，我希望能够使用快捷键快速操作，以便提高工作效率。

#### 验收标准

1. When 用户按下 Delete 或 Backspace 键时，系统应当删除当前选中的文字区域。
2. When 用户按下 Escape 键时，系统应当取消文字检测模式并清除所有矩形框。
3. When 用户按下 Ctrl+A（或 Cmd+A）时，系统应当选中所有文字区域。
4. When 用户按下 Ctrl+D（或 Cmd+D）时，系统应当触发文字检测。

### 需求 7 - 状态持久化

**用户故事：** 作为用户，我希望在切换图片前能够保存当前的文字区域状态，以便在需要时恢复。

#### 验收标准

1. When 用户切换到其他工具时，系统应当保留当前的文字区域状态。
2. When 用户切换回文字检测工具时，系统应当恢复之前的文字区域状态。
3. When 用户加载新图片时，系统应当清空之前的文字区域状态。
4. When 用户执行 Undo 操作时，系统应当恢复上一次的文字区域状态。

## 非功能性需求

### 性能要求

1. OCR 检测响应时间应在 5 秒内（对于 1920x1080 的图片）。
2. 矩形框拖动应保持 60 FPS 的流畅度。
3. 前端状态更新应在 100ms 内完成。

### 兼容性要求

1. 支持 Chrome、Firefox、Safari、Edge 最新版本。
2. 支持 Windows、macOS、Linux 操作系统。
3. 后端支持 Python 3.7+。

### 可用性要求

1. 界面应遵循 IOPaint 现有的设计风格。
2. 所有操作应提供明确的视觉反馈。
3. 错误信息应清晰易懂。

### 安全性要求

1. 上传的图片应进行大小和格式验证。
2. OCR 处理应有超时机制（30 秒）。
3. 防止恶意构造的图片导致服务崩溃。

## 技术约束

1. 必须使用 EasyOCR 库进行文字识别。
2. 必须复用现有的 inpainting API 进行文字移除。
3. 前端必须使用 React + TypeScript + Zustand。
4. 后端必须使用 FastAPI 框架。
5. 必须遵循现有的代码风格和架构模式。

## 依赖关系

1. 依赖现有的 inpainting 功能。
2. 依赖现有的图片加载和显示机制。
3. 依赖现有的状态管理系统（Zustand）。
4. 依赖现有的 API 通信机制。

## 优先级

- P0（必须）：需求 1、需求 4
- P1（重要）：需求 2、需求 3、需求 5
- P2（可选）：需求 6、需求 7

## 里程碑

1. **阶段 1**：后端 OCR API 实现（2 天）
2. **阶段 2**：前端基础 UI 和状态管理（2 天）
3. **阶段 3**：矩形框交互功能（2 天）
4. **阶段 4**：Mask 生成和集成（1 天）
5. **阶段 5**：测试和优化（1 天）

## 风险评估

1. **EasyOCR 性能问题**：大图片可能导致处理时间过长
   - 缓解措施：添加图片尺寸限制，提供进度反馈

2. **矩形框拖动性能**：大量矩形框可能导致卡顿
   - 缓解措施：使用虚拟化技术，限制最大矩形框数量

3. **OCR 准确度问题**：某些字体或场景识别不准确
   - 缓解措施：允许用户手动添加和调整区域

4. **跨浏览器兼容性**：不同浏览器的拖动行为可能不一致
   - 缓解措施：使用成熟的拖动库或充分测试

## 参考资料

- EasyOCR 文档：https://github.com/JaidedAI/EasyOCR
- IOPaint 现有插件实现：`iopaint/plugins/interactive_seg.py`
- 前端 Cropper 组件：`web_app/src/components/Cropper.tsx`

