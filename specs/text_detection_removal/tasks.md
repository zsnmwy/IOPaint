# 实施计划 - 文字识别与移除功能

## 阶段 1: 后端基础设施（预计 2 天）

- [ ] 1.1 添加 EasyOCR 依赖
  - 在 `requirements.txt` 中添加 `easyocr>=1.7.0`
  - 测试依赖安装是否成功
  - _需求: 需求 1_

- [ ] 1.2 创建 OCR 插件基础类
  - 创建 `iopaint/plugins/ocr_plugin.py`
  - 实现 `OCRPlugin` 类，继承 `BasePlugin`
  - 实现 `__init__` 方法，初始化 EasyOCR Reader
  - 实现 `check_dep` 方法，检查依赖
  - _需求: 需求 1_

- [ ] 1.3 实现文字检测核心逻辑
  - 在 `OCRPlugin` 中实现 `detect_text` 方法
  - 处理 EasyOCR 返回的边界框坐标
  - 转换为标准的矩形格式 (x, y, width, height)
  - 生成唯一 ID 和返回置信度
  - _需求: 需求 1_

- [ ] 1.4 添加 Schema 定义
  - 在 `iopaint/schema.py` 中添加 `DetectTextRequest`
  - 添加 `TextRegionBBox` 模型
  - 添加 `TextRegion` 模型
  - 添加 `DetectTextResponse` 模型
  - _需求: 需求 1_

- [ ] 1.5 实现 API 接口
  - 在 `iopaint/api.py` 中添加 `api_detect_text` 方法
  - 实现图片解码和 OCR 调用
  - 实现错误处理和日志记录
  - 添加路由注册
  - _需求: 需求 1_

- [ ] 1.6 集成插件到系统
  - 在 `iopaint/plugins/__init__.py` 中导入 `OCRPlugin`
  - 在 `build_plugins` 函数中添加 OCR 插件初始化
  - 在 `iopaint/cli.py` 中添加 CLI 参数 `--enable-ocr`
  - 在 `ApiConfig` 中添加 OCR 相关配置
  - _需求: 需求 1_

- [ ] 1.7 后端单元测试
  - 创建测试图片（包含中英文文字）
  - 测试 OCR 插件的文字检测功能
  - 测试 API 接口的正确性
  - 测试错误处理逻辑
  - _需求: 需求 1_

## 阶段 2: 前端基础设施（预计 2 天）

- [ ] 2.1 添加类型定义
  - 在 `web_app/src/lib/types.ts` 中添加 `TextRegionBBox` 接口
  - 添加 `TextRegion` 接口
  - 添加 `TextDetectionState` 接口
  - _需求: 需求 1, 需求 2_

- [ ] 2.2 扩展 Zustand Store
  - 在 `web_app/src/lib/states.ts` 中添加 `textDetectionState`
  - 实现 `detectText` action
  - 实现 `updateTextRegion` action
  - 实现 `deleteTextRegion` action
  - 实现 `addTextRegion` action
  - 实现 `clearTextRegions` action
  - 实现 `selectTextRegion` action
  - _需求: 需求 1, 需求 2, 需求 3_

- [ ] 2.3 实现 API 客户端
  - 在 `web_app/src/lib/api.ts` 中添加 `detectText` 函数
  - 实现 Base64 编码和请求发送
  - 实现错误处理
  - _需求: 需求 1_

- [ ] 2.4 创建文字检测按钮组件
  - 创建 `web_app/src/components/TextDetection.tsx`
  - 实现 `TextDetectionButton` 组件
  - 添加加载状态显示
  - 添加到工具栏
  - _需求: 需求 1_

- [ ] 2.5 创建文字区域容器组件
  - 在 `TextDetection.tsx` 中创建 `TextRegionsContainer` 组件
  - 实现矩形框的渲染逻辑
  - 处理缩放比例
  - _需求: 需求 2_

- [ ] 2.6 前端基础测试
  - 测试状态管理的正确性
  - 测试 API 调用
  - 测试组件渲染
  - _需求: 需求 1_

## 阶段 3: 矩形框交互功能（预计 2 天）

- [ ] 3.1 创建 TextRegion 组件基础结构
  - 创建 `web_app/src/components/TextRegion.tsx`
  - 实现基础的矩形框渲染
  - 添加选中状态样式
  - 添加悬停效果
  - _需求: 需求 2, 需求 5_

- [ ] 3.2 实现边缘拖动功能
  - 添加四条边的拖动手柄
  - 实现鼠标事件处理（mousedown, mousemove, mouseup）
  - 实现边界限制逻辑
  - 实现最小尺寸限制
  - 参考 `Cropper.tsx` 的实现
  - _需求: 需求 2_

- [ ] 3.3 实现角落拖动功能
  - 添加四个角的拖动手柄
  - 实现同时调整宽度和高度
  - 实现鼠标光标样式变化
  - _需求: 需求 2_

- [ ] 3.4 实现整体移动功能
  - 实现矩形框中心区域的拖动
  - 实现边界限制
  - 优化拖动性能
  - _需求: 需求 2_

- [ ] 3.5 添加删除按钮
  - 在矩形框上添加删除按钮
  - 实现删除功能
  - 添加删除确认（可选）
  - _需求: 需求 3_

- [ ] 3.6 添加文字标签显示
  - 在矩形框旁边显示识别到的文字
  - 实现文字标签的样式
  - 处理长文本的显示
  - _需求: 需求 5_

- [ ] 3.7 实现选中和高亮
  - 实现点击选中功能
  - 实现选中状态的视觉反馈
  - 实现多选（可选）
  - _需求: 需求 5_

- [ ] 3.8 交互功能测试
  - 测试拖动功能的流畅性
  - 测试边界限制
  - 测试删除功能
  - 测试选中功能
  - _需求: 需求 2, 需求 3_

## 阶段 4: Mask 生成与集成（预计 1 天）

- [ ] 4.1 实现 Mask 生成逻辑
  - 在 Zustand Store 中实现 `generateTextMask` 方法
  - 将文字区域转换为白色矩形
  - 参考 `generateMask` 函数的实现
  - _需求: 需求 4_

- [ ] 4.2 实现文字移除功能
  - 在 Zustand Store 中实现 `removeText` 方法
  - 调用 `generateTextMask` 生成 mask
  - 调用现有的 `runInpainting` 方法
  - 处理成功和失败情况
  - _需求: 需求 4_

- [ ] 4.3 添加移除文字按钮
  - 在工具栏添加"移除文字"按钮
  - 实现按钮的启用/禁用逻辑
  - 添加处理进度显示
  - _需求: 需求 4_

- [ ] 4.4 添加清除所有按钮
  - 添加"清除所有"按钮
  - 实现清除确认对话框
  - 实现清除逻辑
  - _需求: 需求 3_

- [ ] 4.5 添加手动添加区域功能
  - 添加"添加区域"按钮
  - 在图片中心创建新矩形框
  - 设置默认尺寸
  - _需求: 需求 3_

- [ ] 4.6 集成测试
  - 测试完整的文字检测到移除流程
  - 测试 mask 生成的正确性
  - 测试 inpainting 集成
  - _需求: 需求 4_

## 阶段 5: 优化与完善（预计 1 天）

- [ ] 5.1 添加快捷键支持
  - 实现 Delete/Backspace 删除选中区域
  - 实现 Escape 退出文字检测模式
  - 实现 Ctrl+A 全选
  - 实现 Ctrl+D 触发检测
  - 使用 `useHotKey` hook
  - _需求: 需求 6_

- [ ] 5.2 性能优化
  - 优化拖动性能（使用 requestAnimationFrame）
  - 优化大量矩形框的渲染
  - 添加防抖处理
  - _需求: 非功能性需求_

- [ ] 5.3 错误处理优化
  - 添加友好的错误提示
  - 处理网络错误
  - 处理 OCR 超时
  - 处理无文字检测的情况
  - _需求: 需求 1_

- [ ] 5.4 UI/UX 优化
  - 优化矩形框的视觉样式
  - 添加动画效果
  - 优化按钮布局
  - 添加工具提示
  - _需求: 需求 5_

- [ ] 5.5 添加状态持久化（可选）
  - 实现文字区域状态的保存
  - 实现状态恢复
  - 实现 Undo/Redo 支持
  - _需求: 需求 7_

- [ ] 5.6 文档编写
  - 编写用户使用文档
  - 编写开发者文档
  - 更新 README
  - 添加代码注释
  - _需求: 所有需求_

- [ ] 5.7 全面测试
  - 跨浏览器测试（Chrome, Firefox, Safari, Edge）
  - 不同操作系统测试（Windows, macOS, Linux）
  - 不同图片尺寸测试
  - 不同语言文字测试
  - 性能测试
  - _需求: 非功能性需求_

- [ ] 5.8 代码审查与重构
  - 代码风格检查
  - 性能分析
  - 安全审查
  - 重构优化
  - _需求: 所有需求_

## 验收标准检查清单

### 功能验收
- [ ] 用户可以点击"检测文字"按钮识别图片中的文字
- [ ] 前端正确显示所有检测到的文字区域矩形框
- [ ] 用户可以拖动矩形框的边缘调整大小
- [ ] 用户可以拖动矩形框的角落同时调整宽高
- [ ] 用户可以拖动矩形框移动位置
- [ ] 用户可以删除单个文字区域
- [ ] 用户可以手动添加新的文字区域
- [ ] 用户可以清除所有文字区域
- [ ] 用户可以点击"移除文字"执行 inpainting
- [ ] 文字被成功移除，图片其他部分保持完整

### 性能验收
- [ ] OCR 检测响应时间 < 5 秒（1920x1080 图片）
- [ ] 矩形框拖动流畅（60 FPS）
- [ ] 前端状态更新 < 100ms

### 兼容性验收
- [ ] Chrome 最新版本正常运行
- [ ] Firefox 最新版本正常运行
- [ ] Safari 最新版本正常运行
- [ ] Edge 最新版本正常运行

### 用户体验验收
- [ ] 所有操作有明确的视觉反馈
- [ ] 错误信息清晰易懂
- [ ] 界面符合 IOPaint 设计风格
- [ ] 快捷键正常工作

## 风险与依赖

### 风险
1. EasyOCR 性能可能不满足要求 → 添加图片尺寸限制
2. 矩形框拖动可能卡顿 → 使用性能优化技术
3. OCR 准确度可能不够 → 允许手动调整

### 依赖
1. 依赖现有的 inpainting 功能正常工作
2. 依赖 EasyOCR 库的稳定性
3. 依赖前端状态管理系统

## 时间估算

- 阶段 1: 2 天
- 阶段 2: 2 天
- 阶段 3: 2 天
- 阶段 4: 1 天
- 阶段 5: 1 天

**总计: 8 个工作日**

## 下一步行动

1. 确认需求文档和技术方案
2. 开始阶段 1 的开发工作
3. 每个阶段完成后进行代码审查
4. 最终进行全面测试和验收

